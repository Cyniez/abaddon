name: Abaddon CI

on: [ push, pull_request ]

jobs:
  linux-i386:
    name: linux-i386-${{ matrix.buildtype }}
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        buildtype: [ RelWithDebInfo ] # Focus on RelWithDebInfo to save time/RAM
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup i386 Architecture
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update

      - name: Install All Dependencies (including missing ones)
        run: |
          sudo apt-get install -y --no-install-recommends \
            gcc-multilib g++-multilib pkg-config \
            libgtkmm-3.0-dev:i386 \
            libcurl4-gnutls-dev:i386 \
            libssl-dev:i386 \
            libsecret-1-dev:i386 \
            libopus-dev:i386 \
            libsodium-dev:i386 \
            libsqlite3-dev:i386 \
            zlib1g-dev:i386 \
            libasound2-dev:i386 \
            libpulse-dev:i386

      - name: Build nlohmann-json (32-bit)
        run: |
          git clone https://github.com/nlohmann/json deps/json
          cd deps/json && git checkout v3.11.2
          mkdir build && cd build
          cmake .. -DJSON_BuildTests=OFF -DCMAKE_CXX_FLAGS="-m32"
          sudo make install

      - name: Build spdlog (32-bit)
        run: |
          git clone https://github.com/gabime/spdlog deps/spdlog
          cd deps/spdlog && mkdir build && cd build
          cmake .. -DSPDLOG_BUILD_EXAMPLE=OFF -DSPDLOG_BUILD_TESTS=OFF -DCMAKE_CXX_FLAGS="-m32"
          make -j$(nproc)
          sudo make install

      - name: Build Abaddon (32-bit)
        run: |
          # Ensure pkg-config and compiler look ONLY at i386 paths
          export PKG_CONFIG_PATH=/usr/lib/i386-linux-gnu/pkgconfig
