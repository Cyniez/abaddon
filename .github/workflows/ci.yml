name: Abaddon CI

on: [ push, pull_request ]

jobs:
  linux-i386:
    name: linux-i386-${{ matrix.buildtype }}
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        buildtype: [ Debug, RelWithDebInfo, MinSizeRel ]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup i386 Architecture
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update

      - name: Install System Dependencies
        run: |
          # Install 32-bit toolchain and libraries
          # We explicitly install libssl-dev:i386 which might remove the 64-bit version (that is fine for this job)
          sudo apt-get install -y --no-install-recommends \
            gcc-multilib g++-multilib pkg-config \
            libgtkmm-3.0-dev:i386 \
            libcurl4-gnutls-dev:i386 \
            libssl-dev:i386 \
            libopus-dev:i386 \
            libsodium-dev:i386 \
            libsqlite3-dev:i386 \
            zlib1g-dev:i386

      - name: Build nlohmann-json (32-bit)
        run: |
          git clone https://github.com/nlohmann/json deps/json
          cd deps/json && git checkout v3.11.2
          mkdir build && cd build
          # -m32 isn't strictly needed for header-only, but good practice for CMake checks
          cmake .. -DJSON_BuildTests=OFF -DCMAKE_CXX_FLAGS="-m32" -DCMAKE_INSTALL_PREFIX=/usr/local
          sudo make install

      - name: Build spdlog (32-bit)
        run: |
          # Build spdlog manually since i386 package is missing
          git clone https://github.com/gabime/spdlog deps/spdlog
          cd deps/spdlog && mkdir build && cd build
          cmake .. \
            -DSPDLOG_BUILD_EXAMPLE=OFF \
            -DSPDLOG_BUILD_TESTS=OFF \
            -DCMAKE_CXX_FLAGS="-m32" \
            -DCMAKE_INSTALL_PREFIX=/usr/local
          make -j$(nproc)
          sudo make install

      - name: Build Abaddon
        run: |
          # PKG_CONFIG_PATH ensures we find the 32-bit libraries (gtkmm, etc.)
          export PKG_CONFIG_PATH=/usr/lib/i386-linux-gnu/pkgconfig
          
          # CXXFLAGS includes the path to the 32-bit OpenSSL headers specifically
          export CXXFLAGS="-m32 -I/usr/include/i386-linux-gnu"
          export CFLAGS="-m32 -I/usr/include/i386-linux-gnu"
          export LDFLAGS="-m32"

          cmake -Bbuild \
            -DCMAKE_BUILD_TYPE=${{ matrix.buildtype }} \
            -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
            -DCMAKE_C_FLAGS="$CFLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS" \
            -DUSE_LIBHANDY=OFF \
            -DENABLE_VOICE=ON
          
          cmake --build build --parallel $(nproc)

      - name: Setup artifact files
        run: |
          artifact_dir=${{ runner.workspace }}/artifactdir/abaddon-linux-i386-${{ matrix.buildtype }}-${GITHUB_SHA::7}
          mkdir -p "${artifact_dir}"
          cp "${{ github.workspace }}/build/abaddon" "${artifact_dir}/abaddon"
          cp -r "${{ github.workspace }}/res/css" "${artifact_dir}/css"
          cp -r "${{ github.workspace }}/res/res" "${artifact_dir}/res"

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: build-linux-i386-${{ matrix.buildtype }}
          path: ${{ runner.workspace }}/artifactdir
