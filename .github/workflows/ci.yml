name: Abaddon i386 Build

on: [ push, pull_request ]

jobs:
  linux-i386:
    name: linux-i386-debian-bookworm
    runs-on: ubuntu-latest
    # We use a native 32-bit container to avoid cross-compilation headaches
    container:
      image: i386/debian:bookworm
    steps:
      - name: Install Git
        run: |
          apt-get update
          apt-get install -y git ca-certificates

      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            g++ cmake make pkg-config \
            libgtkmm-3.0-dev \
            libcurl4-gnutls-dev \
            libsqlite3-dev \
            libssl-dev \
            nlohmann-json3-dev \
            libhandy-1-dev \
            libsecret-1-dev \
            libopus-dev \
            libsodium-dev \
            libspdlog-dev \
            libasound2-dev \
            libpulse-dev

      - name: Build Abaddon
        run: |
          mkdir build && cd build
          # -DCMAKE_DISABLE_PRECOMPILE_HEADERS=ON saves RAM
          cmake .. \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DENABLE_VOICE=ON \
            -DENABLE_RNNOISE=ON \
            -DUSE_LIBHANDY=ON \
            -DCMAKE_DISABLE_PRECOMPILE_HEADERS=ON
          
          # Build with 2 cores to prevent the runner from running out of memory
          make -j2

      - name: Setup Artifact Files
        run: |
          # Create the bundle directory
          mkdir -p abaddon-bundle
          
          # Copy the binary
          cp build/abaddon abaddon-bundle/
          
          # Copy the required resources (css and res folders)
          # These must be in the same directory as the binary to work
          cp -r res/css abaddon-bundle/
          cp -r res/res abaddon-bundle/
          
          # Optional: Strip the binary to make it much smaller for 386 hardware
          strip abaddon-bundle/abaddon

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: abaddon-linux-i386-portable
          path: abaddon-bundle/
