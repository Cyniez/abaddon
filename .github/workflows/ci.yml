name: Abaddon i386 Build

on: [ push, pull_request ]

jobs:
  linux-i386:
    name: linux-i386-${{ matrix.buildtype }}
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        buildtype: [ RelWithDebInfo ]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup i386 Architecture
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update

      - name: Install All Dependencies
        run: |
          sudo apt-get install -y --no-install-recommends \
            gcc-multilib g++-multilib pkg-config \
            libgtkmm-3.0-dev:i386 \
            libcurl4-gnutls-dev:i386 \
            libssl-dev:i386 \
            libsecret-1-dev:i386 \
            libopus-dev:i386 \
            libsodium-dev:i386 \
            libsqlite3-dev:i386 \
            zlib1g-dev:i386 \
            libasound2-dev:i386 \
            libpulse-dev:i386

      - name: Build nlohmann-json (32-bit)
        run: |
          git clone https://github.com/nlohmann/json deps/json
          cd deps/json && git checkout v3.11.2
          mkdir build && cd build
          # Use /usr as prefix so the main build finds it easily
          cmake .. -DJSON_BuildTests=OFF -DCMAKE_CXX_FLAGS="-m32" -DCMAKE_INSTALL_PREFIX=/usr
          sudo make install

      - name: Build spdlog (32-bit)
        run: |
          git clone https://github.com/gabime/spdlog deps/spdlog
          cd deps/spdlog && mkdir build && cd build
          cmake .. -DSPDLOG_BUILD_EXAMPLE=OFF -DSPDLOG_BUILD_TESTS=OFF -DCMAKE_CXX_FLAGS="-m32" -DCMAKE_INSTALL_PREFIX=/usr
          make -j$(nproc)
          sudo make install

      - name: Build Abaddon (32-bit)
        run: |
          # 1. Force pkg-config to look ONLY at 32-bit library metadata
          export PKG_CONFIG_PATH=/usr/lib/i386-linux-gnu/pkgconfig
          export PKG_CONFIG_LIBDIR=/usr/lib/i386-linux-gnu/pkgconfig
          
          # 2. Add the architecture-specific include path (Fixes OpenSSL/libsecret headers)
          export CXXFLAGS="-m32 -I/usr/include/i386-linux-gnu"
          export CFLAGS="-m32 -I/usr/include/i386-linux-gnu"
          export LDFLAGS="-m32 -L/usr/lib/i386-linux-gnu"

          cmake -Bbuild \
            -DCMAKE_BUILD_TYPE=${{ matrix.buildtype }} \
            -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
            -DCMAKE_C_FLAGS="$CFLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS" \
            -DUSE_LIBHANDY=OFF \
            -DENABLE_VOICE=ON \
            -DENABLE_QRCODE_LOGIN=ON \
            -DENABLE_RNNOISE=ON \
            -DCMAKE_DISABLE_PRECOMPILE_HEADERS=ON

          # Build using 2 cores (Faster than 1, safer than 'all' for RAM)
          cmake --build build --parallel 2

      - name: Setup artifact files
        run: |
          # Use GITHUB_WORKSPACE for consistent paths
          artifact_dir="${{ github.workspace }}/abaddon-i386-dist"
          mkdir -p "${artifact_dir}"
          
          # Copy the binary and strip symbols to reduce size (important for old hardware)
          cp build/abaddon "${artifact_dir}/abaddon"
          strip "${artifact_dir}/abaddon"
          
          # Copy resources (Abaddon needs these in the same folder or relative to the exe)
          cp -r res/css "${artifact_dir}/css"
          cp -r res/res "${artifact_dir}/res"

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: abaddon-linux-i386
          path: ${{ github.workspace }}/abaddon-i386-dist/
